(function(){angular.module("maestrano.transac",["transac.components","transac.common","ngSanitize"]).config(["$httpProvider",function(n){return n.defaults.headers.common.Accept="application/json",n.defaults.headers.common["Content-Type"]="application/json"}])}).call(this),function(){angular.module("transac.common",["transac.top-bar"])}.call(this),function(){angular.module("transac.components",["transac.user","transac.transactions"])}.call(this),function(){angular.module("transac.top-bar",[]).constant("MENUS",[{title:"Transactions",active:!0},{title:"History",active:!1}]).value("EventEmitter",function(n){return{$event:n}})}.call(this),function(){angular.module("transac.user",[])}.call(this),function(){angular.module("transac.transactions",["transac.user"]).value("EventEmitter",function(n){return{$event:n}}).constant("DEV_AUTH",{apiKey:"9f59b930-ded2-0134-88ae-0dc5706ed3c0",apiSecret:"YG4pnBBqY4zkVXuGcR1nwg",orgUid:"org-fbba"})}.call(this),angular.module("maestrano.transac").run(["$templateCache",function(n){n.put("transac",'<div ng-if="$ctrl.transacReady">\n  <top-bar ng-show="$ctrl.isTopBarShown" on-select-menu="$ctrl.onTopBarSelectMenu($event)" transactions-count="$ctrl.transactionsCount"></top-bar>\n\n  <transactions on-transactions-change="$ctrl.updateTransactionsCount($event)" on-reconciling="$ctrl.toggleTopBar($event)"></transactions>\n</div>\n<div ng-if="!$ctrl.transacReady">\n  <p>Loading...</p>\n</div>\n\n'),n.put("common/top-bar",'<div class="menu">\n  <a href="" class="menu-tab" ng-class="{ \'active\': menu.active }" ng-click="$ctrl.onMenuItemClick(menu)" ng-repeat="menu in $ctrl.menus track by $index">\n    <h5>{{::menu.title}} ({{$ctrl.getCount(menu)}})</h5>\n  </a>\n</div>\n'),n.put("components/transactions/transaction",'<div ng-class="{ \'selected\': $ctrl.isSelected }">\n  <div class="summary">\n    <a href="" class="summary-title" ng-click="$ctrl.selectOnClick()">\n      <div class="summary-title-caption">\n        <span>{{::$ctrl.title()}}</span>\n      </div>\n      <div class="summary-title-warning">\n        <div ng-if="$ctrl.hasMatches()">\n          <i class="fa fa-exclamation-triangle fa-lg"></i>\n          <span>This record may be a duplicate</span>\n        </div>\n      </div>\n    </a>\n    <div class="summary-actions">\n      <button type="button" class="summary-actions-action--deny" ng-click="$ctrl.denyOnClick()">\n        <i class="fa fa-times fa-2x"></i>\n      </button>\n      <button type="button" class="summary-actions-action--approve" ng-click="$ctrl.approveOnClick(true)">\n        <i class="fa fa-check fa-2x"></i>\n      </button>\n    </div>\n  </div>\n  <div class="detail" ng-if="$ctrl.isSelected">\n    <div class="row">\n      <div class="col-md-6 detail-section no-gutters">\n        <transaction-changes changes="$ctrl.changes"></transaction-changes>\n      </div>\n      <div class="col-md-3 detail-section no-gutters">\n        <div class="detail-section-title">\n          <h5>Select apps to share with:</h5>\n        </div>\n        <div class="detail-section-app" ng-repeat="mapping in ::$ctrl.transaction.mappings track by mapping.group_id" ng-click="$ctrl.selectAppOnClick($event, mapping)">\n          <span>{{::mapping.app_name}}</span>\n          <input type="checkbox" ng-checked="mapping.sharedWith">\n        </div>\n      </div>\n      <div class="col-md-3 detail-section no-gutters">\n        <div class="detail-section-action detail-section-action--approve" ng-click="$ctrl.approveOnClick()">\n          <span>Approve only this time</span>\n          <button type="button">\n            <i class="fa fa-check fa-2x"></i>\n          </button>\n        </div>\n        <div class="detail-section-action detail-section-action--deny" ng-click="$ctrl.denyOnClick(true)">\n          <span>Never share this record</span>\n          <button type="button">\n            <i class="fa fa-ban"></i>\n          </button>\n        </div>\n        <div class="detail-section-action detail-section-action--duplicate" ng-click="$ctrl.reconcileOnClick()" ng-if="$ctrl.hasMatches()">\n          <span>This record is a duplicate</span>\n          <button type="button">\n            <i class="fa fa-link fa-2x"></i>\n          </button>\n        </div>\n      </div>\n    </div>\n    <div ng-if="$ctrl.hasMatches()">\n      <div class="row detail-spacers">\n        <div class="detail-spacers-spacer detail-spacers-spacer--left"></div>\n        <div class="detail-spacers-title">\n          <div>\n            <i class="fa fa-exclamation fa-lg"></i>\n            <span>Potential Duplicates</span>\n          </div>\n        </div>\n        <div class="detail-spacers-spacer detail-spacers-spacer--right"></div>\n      </div>\n      <div class="row">\n        <div class="col-md-12 col-xs-12 detail-section detail-section-matches">\n          <div ng-repeat="match in ::$ctrl.matches" class="detail-section-matches-match">\n            {{::$ctrl.matchTitle(match)}}\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n'),n.put("components/transactions/transaction-changes",'<div class="table-responsive">\n  <table class="table table-striped borderless">\n    <tr>\n      <th ng-if="$ctrl.onSelect">Tick</th>\n      <th>Field</th>\n      <th>Value</th>\n    </tr>\n    <tr ng-repeat="(key, value) in ::$ctrl.changes">\n      <td ng-if="$ctrl.onSelect"><input type="checkbox"></td>\n      <td>{{::key}}</td>\n      <td>{{::value}}</td>\n    </tr>\n  </table>\n</div>\n'),n.put("components/transactions/transaction-reconcile",'<div class="top-panel">\n  <button class="top-panel_action-btns" ng-click="$ctrl.back()">\n    <i class="fa fa-angle-double-left fa-2x"></i>\n  </button>\n  <div class="top-panel_title">\n    <span>Reconcile duplicate records</span>\n  </div>\n  <button class="top-panel_action-btns right-align" ng-if="$ctrl.isNextBtnShown()" ng-click="$ctrl.next()">\n    <i class="fa fa-angle-double-right fa-2x"></i>\n  </button>\n  <button class="top-panel_action-btns top-panel_action-btns--done right-align" ng-if="!$ctrl.editing" ng-click="$ctrl.publish()">\n    <i class="fa fa-check fa-2x"></i>\n  </button>\n</div>\n<div class="edit" ng-show="$ctrl.editing">\n  <div class="edit_tx">\n    <transaction-tile  ng-repeat="tx in ::$ctrl.transactions track by tx.id" transaction="::tx" checked="$ctrl.isTxChecked(tx)" on-select="$ctrl.onSelect($event)"></transaction-tile>\n  </div>\n</div>\n<div class="review" ng-if="!$ctrl.editing">\n  <div class="review_tx">\n    <transaction-tile transaction="$ctrl.selectedTx" title="$ctrl.selectedTxTitle" subtitle="$ctrl.selectedTxSubtitle"></transaction-tile>\n  </div>\n</div>\n'),n.put("components/transactions/transaction-tile",'<div class="tx-tile">\n  <div class="tx-tile_topbar row no-gutters" ng-class="{\'no-click\': !$ctrl.isOnSelectDefined()}" ng-click="$ctrl.onSelectTx()">\n    <div class="tx-tile_topbar_checkbox" ng-if="$ctrl.isOnSelectDefined()">\n      <input type="checkbox" ng-checked="$ctrl.checked">\n    </div>\n    <div class="tx-tile_topbar_text">\n      <h5>{{::$ctrl.title}}</h5>\n      <span>{{::$ctrl.subtitle}}</span>\n    </div>\n  </div>\n  <transaction-changes changes="::$ctrl.transaction.formatted"></transaction-changes>\n</div>\n'),n.put("components/transactions/transactions",'<div ng-if="!$ctrl.loading">\n  <div ng-hide="$ctrl.reconciling">\n    <!-- <transactions-controls></transactions-controls> -->\n    <transaction transaction="transaction" ng-repeat="transaction in $ctrl.transactions track by transaction.transaction_log.id" on-commit="$ctrl.onTransactionCommit($event)" on-reconcile="$ctrl.onReconcileTransactions($event)"></transaction>\n  </div>\n  <div ng-if="$ctrl.reconciling">\n    <transaction-reconcile transaction="$ctrl.reconcileData.transaction" matches="$ctrl.reconcileData.matches" apps="$ctrl.reconcileData.apps" on-reconciled="$ctrl.onTransactionReconciled($event)"></transaction-reconcile>\n  </div>\n</div>\n<div ng-if="$ctrl.loading">\n  <p>Loading Transactions...</p>\n</div>\n')}]),function(){angular.module("maestrano.transac").component("transac",{bindings:{},templateUrl:"transac",controller:["TransacUserService",function(n){var t,e;t=this,e=function(){return n.fetch().then(function(n){return t.transacReady=!0,console.log(n)},function(n){return t.transacReady=!0,t.transacLoadError=!0})},t.$onInit=function(){return t.transacReady=!1,t.isTopBarShown=!0,t.transactionsCount=0,e()},t.onTopBarSelectMenu=function(n){var t;return t=n.menu,console.log("selected menu: ",t)},t.updateTransactionsCount=function(n){var e,a;return e=n.count,a=n.topbar,t.transactionsCount=e},t.toggleTopBar=function(n){var e;return e=n.isReconciling,t.isTopBarShown=!e}}]})}.call(this),function(){angular.module("transac.top-bar").component("topBar",{bindings:{onSelectMenu:"&",transactionsCount:"<"},templateUrl:"common/top-bar",controller:["MENUS","EventEmitter",function(n,t){var e;e=this,e.$onInit=function(){return e.menus=n},e.onMenuItemClick=function(n){return _.each(e.menus,function(n){n.active=!1}),n.active=!0,e.onSelectMenu(t({menu:n}))},e.getCount=function(n){return n.title&&e[n.title.toLowerCase()+"Count"]||0}}]})}.call(this),function(){angular.module("transac.user").provider("TransacUserService",function(){var n,t,e;return e=this,t={user:null,organizations:null},e.configure=function(n){return angular.extend(t,n)},n=function(n,e){var a;return a=this,a.user={},a.get=function(){return angular.copy(a.user)},a.getCurrentOrg=function(){return _.isEmpty(a.user)?{}:_.find(a.user.organizations,function(n){return n.id===a.user.currentOrgId})},a.fetch=function(){var c;return c=_.map(t,function(t,e){return null!=t?t():n.reject("transac error: no "+e+" callback configured.")}),n.all(c).then(function(n){return a.user=angular.merge(n[0],n[1]),a.user},function(t){return e.error(t),n.reject(t)})},a},n.$inject=["$q","$log"],e.$get=n,e})}.call(this),function(){angular.module("transac.transactions").service("TransactionsService",["$http","TransacUserService","DEV_AUTH",function(n,t,e){var a;return a=this,a.HTTP_CONFIG={},this.developer=function(){return _.isUndefined(a._developer)?e.apiKey&&e.apiSecret&&e.orgUid?(a.HTTP_CONFIG={headers:{Authorization:"Basic "+window.btoa(e.apiKey+":"+e.apiSecret)}},a._developer=!0):(a.HTTP_CONFIG={params:{sso_session:t.get().sso_session}},a._developer=!1):a.developer},this.get=function(c){var i,r;return null==c&&(c="pending"),i=a.developer()?e.orgUid:t.getCurrentOrg().uid,r="https://api-connec-sit.maestrano.io/api/v2/"+i+"/transaction_logs/"+c,n.get(r,a.HTTP_CONFIG).then(function(n){return{transactions:n.data.transactions}},function(n){return console.error(n),n})},this.commit=function(t,e,c){var i;return null==c&&(c=[]),i={mappings:c},n.put(t,i,a.HTTP_CONFIG).then(function(n){return{transaction:n.data[e]}},function(n){return console.error(n),n})},this.matches=function(t,e,c){return null==c&&(c={}),c=angular.merge({},a.HTTP_CONFIG,c),n.get(t,c).then(function(n){return{matches:n.data[e]||[],pagination:n.data.pagination}},function(n){return console.error(n),n})},this.merge=function(t,e,c){return null==c&&(c={}),n.put(t,c,a.HTTP_CONFIG).then(function(n){return{transaction:n.data[e]}},function(n){return console.error(n),n})},this.formatTitle=function(n){var t,e,a,c;return t=n.transaction_log.action.toLowerCase(),e=n.transaction_log.resource_type,a=_.capitalize(_.words(e).join(" ")),c=function(){switch(e){case"credit_notes":return _.get(n.changes,"transaction_number")+" ("+_.get(n.changes,"type")+")";default:return _.get(n.changes,"name","No name found")}}(),t+" "+a+": "+c},this.formatMatchTitle=function(n){var t,e,a;return e=function(){switch(n.resource_type){case"organizations":return t=_.map(n,function(n,t){if(_.includes(t,["is_"])&&n===!0)return t}),t=_.compact(t)[0],a=t.split("_").slice(-1),a+": "+n.name;default:return _.get(n,"name","No name found")}}()},this.formatChanges=function(n){var t,e;return e=function(){switch(n.resource_type){case"organizations":return["name","status","address","email","phone","referred_leads","website"];case"tax_codes":return["name","reference","sale_tax_rate","sale_taxes","status","tax_type"];case"accounts":return["name","reference","code","currency","description","status"];default:return[]}}(),t=_.pick(n,e),t=_.isEmpty(t)?n:t,n.formatted=a.flattenObject(t),n},this.flattenObject=function(n,t,e){return null==t&&(t={}),null==e&&(e=null),_.isObject(n)?_.each(n,function(n,c){return a.flattenObject(n,t,(e?e+"_":"")+c)}):t[e]=n,t},this}])}.call(this),function(){angular.module("transac.transactions").component("transaction",{bindings:{transaction:"<",onCommit:"&",onReconcile:"&"},templateUrl:"components/transactions/transaction",controller:["TransactionsService","EventEmitter",function(n,t){var e;e=this,e.$onInit=function(){return e.changes=n.flattenObject(e.transaction.changes),_.each(e.transaction.mappings,function(n){return n.sharedWith=!0}),n.matches(e.transaction.links.matches,e.transaction.transaction_log.resource_type).then(function(n){return e.matches=n.matches},function(n){})},e.title=function(){return n.formatTitle(e.transaction)},e.matchTitle=function(t){return n.formatMatchTitle(t)},e.hasMatches=function(){return e.matches&&e.matches.length},e.selectOnClick=function(){return e.isSelected=!e.isSelected},e.approveOnClick=function(n){return null==n&&(n=!1),_.each(e.transaction.mappings,function(t){t.commit=t.sharedWith,t.auto_commit=n}),e.onCommit(t({transaction:e.transaction}))},e.denyOnClick=function(n){return null==n&&(n=!1),_.each(e.transaction.mappings,function(t){t.commit=!t.sharedWith,t.push_disabled=n}),e.onCommit(t({transaction:e.transaction}))},e.reconcileOnClick=function(){var n;if(e.hasMatches())return n=angular.merge({},e.transaction.transaction_log,e.transaction.changes),e.onReconcile(t({transaction:n,matches:e.matches,apps:_.map(e.transaction.mappings,function(n){return n.app_name})}))},e.selectAppOnClick=function(n,t){return t.sharedWith=!t.sharedWith}}]})}.call(this),function(){angular.module("transac.transactions").component("transactionChanges",{bindings:{changes:"<",onSelect:"&?"},templateUrl:"components/transactions/transaction-changes",controller:["EventEmitter",function(n){var t;t=this,t.$onInit=function(){}}]})}.call(this),function(){angular.module("transac.transactions").component("transactionReconcile",{bindings:{transaction:"<",matches:"<",apps:"<",onReconciled:"&"},templateUrl:"components/transactions/transaction-reconcile",controller:["EventEmitter",function(n){var t;t=this,t.$onInit=function(){return t.editing=!0,t.transactions=[].concat(t.transaction,t.matches),t.selectedTx={},t.txsSelectionMap={},_.each(_.map(t.transactions,function(n){return n.id}),function(n){t.txsSelectionMap[n]=!1})},t.onSelect=function(n){var e;return e=n.tx,_.each(t.txsSelectionMap,function(n,a){a!==e.id&&(t.txsSelectionMap[a]=!1)}),t.txsSelectionMap[e.id]=!0,t.selectedTx=_.find(t.transactions,function(n){return t.txsSelectionMap[n.id]})},t.isTxChecked=function(n){return t.txsSelectionMap[n.id]},t.isSelectedTxSelected=function(){return!_.isEmpty(t.selectedTx)},t.isNextBtnShown=function(){return t.editing&&t.isSelectedTxSelected()},t.next=function(){if(t.isNextBtnShown())return t.selectedTxTitle="Reconciled Record",t.selectedTxSubtitle="will be updated in "+t.apps.join(", "),t.editing=!1},t.publish=function(){return t.onReconciled(n({txId:t.transaction.id,mergeParams:{ids:_.map(t.matches,function(n){return n.id})}}))},t.back=function(){return t.editing?t.onReconciled(n(null)):t.editing=!0}}]})}.call(this),function(){angular.module("transac.transactions").component("transactionTile",{bindings:{transaction:"<",title:"<?",subtitle:"<?",checked:"<?",onSelect:"&?"},templateUrl:"components/transactions/transaction-tile",controller:["EventEmitter",function(n){var t;t=this,t.$onInit=function(){return t.title||(t.title="Transaction"),t.subtitle||(t.subtitle=t.transaction.app_name?"From "+t.transaction.app_name:"")},t.isOnSelectDefined=function(){return!_.isUndefined(t.onSelect)},t.onSelectTx=function(){if(t.isOnSelectDefined())return t.onSelect(n({tx:t.transaction}))},t.onSelectTxField=function(){}}]})}.call(this),function(){angular.module("transac.transactions").component("transactions",{bindings:{onTransactionsChange:"&",onReconciling:"&"},templateUrl:"components/transactions/transactions",controller:["EventEmitter","TransactionsService",function(n,t){var e;e=this,e.$onInit=function(){return e.reconciling=!1,e.loading=!0,t.get().then(function(t){return e.transactions=t.transactions,e.onTransactionsChange(n({count:e.transactions.length}))},function(n){}).finally(function(){return e.loading=!1})},e.onTransactionCommit=function(a){var c;return c=a.transaction,t.commit(c.links.commit,c.transaction_log.resource_type,c.mappings).then(function(t){return e.transactions=_.reject(e.transactions,function(n){return n.transaction_log.id===c.transaction_log.id}),e.onTransactionsChange(n({count:e.transactions.length}))},function(n){})},e.onReconcileTransactions=function(a){var c,i,r;return r=a.transaction,i=a.matches,c=a.apps,e.reconcileData={transaction:t.formatChanges(r),matches:_.map(i,function(n){return t.formatChanges(n)}),apps:c},e.reconciling=!0,e.onReconciling(n({isReconciling:!0}))},e.onTransactionReconciled=function(a){var c;if(e.reconcileData=null,e.reconciling=!1,e.onReconciling(n({isReconciling:!1})),null!=a&&(c=_.find(e.transactions,function(n){return n.transaction_log.id===a.txId}),null!=c))return t.merge(c.links.merge,c.transaction_log.resource_type,a.mergeParams).then(function(t){return e.transactions=_.reject(e.transactions,function(n){return n.transaction_log.id===c.transaction_log.id}),e.onTransactionsChange(n({count:e.transactions.length}))},function(n){})}}]})}.call(this);